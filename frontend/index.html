<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 Automated PDF Study Guide Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        :root {
            --primary-color: #10a37f;
            --secondary-color: #0d8f6e;
            --accent-color: #19c37d;
            --success-color: #10a37f;
            --warning-color: #ff8c00;
            --error-color: #ff6b6b;
            --info-color: #74b9ff;
            --bg-primary: #212121;
            --bg-secondary: #2f2f2f;
            --bg-tertiary: #3c3c3c;
            --bg-quaternary: #1a1a1a;
            --text-primary: #ececec;
            --text-secondary: #b3b3b3;
            --text-muted: #8e8ea0;
            --border-color: #4a4a4a;
            --border-light: #565869;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.6);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-quaternary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-primary);
            box-shadow: var(--shadow-xl);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-quaternary);
            color: var(--text-primary);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .sidebar-content {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Round Action Buttons */
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .round-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
            position: relative;
        }

        .round-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }

        .round-btn.profile-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-color: var(--primary-color);
        }

        .round-btn.profile-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(16, 163, 127, 0.4);
        }

        .round-btn.new-chat-btn:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .section-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .section-card:hover {
            border-color: var(--border-light);
            transform: translateY(-1px);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* File Upload Styles */
        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 32px 20px;
            text-align: center;
            background: var(--bg-tertiary);
            transition: var(--transition);
            cursor: pointer;
            margin-bottom: 16px;
        }

        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: var(--primary-color);
            background: var(--bg-quaternary);
            transform: translateY(-1px);
        }

        .file-drop-zone.drag-over {
            border-color: var(--accent-color);
            background: rgba(16, 163, 127, 0.1);
        }

        .upload-icon {
            font-size: 2.5rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .file-drop-zone p {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .file-drop-zone small {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .file-item:hover {
            border-color: var(--border-light);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-icon {
            color: var(--error-color);
            font-size: 1.2rem;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .remove-file {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .remove-file:hover {
            background: var(--error-color);
            color: white;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-full {
            width: 100%;
        }

        .process-btn {
            width: 100%;
            margin-top: 16px;
        }

        /* Stats and Progress Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .stat-item:hover {
            border-color: var(--border-light);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.5s ease;
        }

        /* Session Stats */
        .session-stats {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .streak-badge {
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .main-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .main-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Chat Interface */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px 24px 100px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        /* Custom scrollbar for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 800px;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary-color);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--accent-color);
            color: white;
        }

        .message-content {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            flex: 1;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-light);
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .confidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.7rem;
        }

        .confidence-high {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .confidence-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .confidence-low {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        /* Chat Input */
        .chat-input-container {
            position: fixed;
            bottom: 20px;
            left: calc(280px + (100vw - 280px) / 2);
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 12px 16px;
            box-shadow: var(--shadow-xl);
            z-index: 100;
            max-width: 700px;
            width: calc(100vw - 280px - 80px);
            backdrop-filter: blur(10px);
        }

        .chat-input-form {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .mode-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            min-width: 100px;
        }

        .mode-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-primary);
        }

        .chat-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.875rem;
            resize: none;
            font-family: inherit;
            transition: var(--transition);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .chat-input:focus {
            outline: none;
            background: var(--bg-primary);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .upload-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-secondary);
            padding: 48px 24px;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 0.875rem;
            max-width: 400px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        /* Loading and Animations */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Alert System */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .alert {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 0.875rem;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .alert.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .alert.success::before {
            background: var(--success-color);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert.error::before {
            background: var(--error-color);
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .alert.warning::before {
            background: var(--warning-color);
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .alert.info::before {
            background: var(--info-color);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }

            .chat-input-container {
                left: calc(280px + (100vw - 280px) / 2);
                width: calc(100vw - 280px - 80px);
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                order: 2;
            }

            .main-content {
                order: 1;
                height: 50vh;
            }

            .chat-input-container {
                left: 50%;
                width: calc(100% - 40px);
                bottom: 10px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .alert-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }

        /* Study Guide Pages */
        .study-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 1500;
            display: none;
            overflow-y: auto;
        }

        .study-page.active {
            display: block;
        }

        .study-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .study-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .study-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Enhanced Roadmap Styles */
        .roadmap-container {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 0;
        }

        .roadmap-header {
            text-align: center;
            margin-bottom: 48px;
            padding: 32px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 20px;
            color: white;
        }

        .roadmap-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .roadmap-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .roadmap-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin: 32px 0;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .roadmap-step {
            display: flex;
            margin-bottom: 48px;
            position: relative;
            opacity: 0;
            animation: slideInUp 0.6s ease forwards;
        }

        .roadmap-step:nth-child(1) { animation-delay: 0.1s; }
        .roadmap-step:nth-child(2) { animation-delay: 0.2s; }
        .roadmap-step:nth-child(3) { animation-delay: 0.3s; }
        .roadmap-step:nth-child(4) { animation-delay: 0.4s; }
        .roadmap-step:nth-child(5) { animation-delay: 0.5s; }

        .roadmap-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 40px;
            top: 90px;
            width: 3px;
            height: calc(100% + 8px);
            background: linear-gradient(to bottom, var(--primary-color), var(--accent-color));
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(16, 163, 127, 0.3);
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 32px;
            flex-shrink: 0;
        }

        .step-number {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 8px 20px rgba(16, 163, 127, 0.4);
            position: relative;
            z-index: 2;
            transition: var(--transition);
        }

        .step-number:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(16, 163, 127, 0.6);
        }

        .step-icon {
            margin-top: 12px;
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.2rem;
            border: 2px solid var(--border-color);
        }

        .step-content {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            margin-top: 8px;
            position: relative;
            overflow: hidden;
        }

        .step-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .step-content:hover {
            border-color: var(--primary-color);
            transform: translateY(-4px) translateX(8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .step-badge {
            background: rgba(16, 163, 127, 0.1);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(16, 163, 127, 0.2);
        }

        .step-description {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .step-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .step-action-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .step-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Flashcard Styles */
        .flashcard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .flashcard {
            height: 250px;
            perspective: 1000px;
            cursor: pointer;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }

        .flashcard-front {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .flashcard-back {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: rotateY(180deg);
        }

        .flashcard-text {
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.5;
            text-align: center;
        }

        .flashcard-label {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        /* Quiz Styles */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quiz-progress {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
        }

        .progress-bar-container {
            background: var(--bg-tertiary);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .quiz-question {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .question-number {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .quiz-options {
            display: grid;
            gap: 12px;
        }

        .quiz-option {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quiz-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-secondary);
        }

        .quiz-option.selected {
            border-color: var(--primary-color);
            background: rgba(16, 163, 127, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
        }

        .quiz-option.incorrect {
            border-color: var(--error-color);
            background: rgba(255, 107, 107, 0.1);
        }

        .option-letter {
            width: 32px;
            height: 32px;
            background: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .quiz-option.selected .option-letter {
            background: var(--primary-color);
            color: white;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
        }

        .quiz-results {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .results-score {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .results-message {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        /* GitHub-Style Profile Page */
        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 1500;
            display: none;
            overflow-y: auto;
        }

        .profile-page.active {
            display: block;
        }

        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 32px;
        }

        .profile-sidebar {
            position: sticky;
            top: 24px;
            height: fit-content;
        }

        .profile-main {
            min-height: 100vh;
        }

        .profile-close {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            z-index: 1600;
        }

        .profile-close:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }

        .profile-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin-bottom: 16px;
            border: 4px solid var(--bg-primary);
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .profile-username {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .profile-bio {
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .profile-stats-mini {
            display: flex;
            gap: 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .profile-stats-mini span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .profile-stats-mini .number {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Contribution Heatmap */
        .contribution-section {
            margin-bottom: 32px;
        }

        .contribution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .contribution-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .contribution-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .heatmap-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 12px);
            gap: 2px;
            margin-bottom: 8px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .heatmap-day:hover {
            border-color: var(--primary-color);
        }

        .heatmap-day.level-0 { background: var(--bg-tertiary); }
        .heatmap-day.level-1 { background: rgba(16, 163, 127, 0.3); }
        .heatmap-day.level-2 { background: rgba(16, 163, 127, 0.5); }
        .heatmap-day.level-3 { background: rgba(16, 163, 127, 0.7); }
        .heatmap-day.level-4 { background: var(--primary-color); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .heatmap-legend-scale {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .heatmap-legend-item {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid var(--border-color);
        }

        /* Streak Cards */
        .streak-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 32px;
        }

        .streak-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: var(--transition);
        }

        .streak-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .streak-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .current-streak .streak-icon {
            color: var(--warning-color);
        }

        .max-streak .streak-icon {
            color: var(--primary-color);
        }

        .streak-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .streak-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Activity Stats */
        .activity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .activity-stat {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .activity-stat-icon {
            width: 40px;
            height: 40px;
            background: rgba(16, 163, 127, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .activity-stat-content {
            flex: 1;
        }

        .activity-stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .activity-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Achievements Section */
        .achievements-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .achievement-badge {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .achievement-badge.earned {
            border-color: var(--primary-color);
            background: rgba(16, 163, 127, 0.05);
        }

        .achievement-badge:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
        }

        .achievement-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .achievement-badge.earned .achievement-icon {
            color: var(--primary-color);
        }

        .achievement-badge:not(.earned) .achievement-icon {
            color: var(--text-muted);
            opacity: 0.5;
        }

        .achievement-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .profile-container {
                grid-template-columns: 1fr;
                gap: 24px;
                padding: 16px;
            }

            .profile-sidebar {
                position: static;
            }

            .streak-section {
                grid-template-columns: 1fr;
            }

            .heatmap-grid {
                grid-template-columns: repeat(26, 12px);
            }
        }

        /* Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .upload-modal.active {
            display: flex;
        }

        .upload-modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }

        .upload-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .upload-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Quick Action Cards */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .action-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: inherit;
        }

        .action-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .action-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 16px;
        }

        .action-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .action-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Notes Styles */
        .notes-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .notes-header {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .notes-topic {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .notes-summary {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .note-item {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .note-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .note-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .note-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .note-details {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .note-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword-tag {
            background: rgba(16, 163, 127, 0.1);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(16, 163, 127, 0.2);
        }

        /* Enhanced Markdown Styles */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            color: var(--text-primary);
            font-weight: 600;
            margin: 20px 0 12px 0;
            line-height: 1.3;
        }

        .message-content h1 {
            font-size: 1.75rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .message-content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
        }

        .message-content h3 {
            font-size: 1.25rem;
        }

        .message-content h4 {
            font-size: 1.1rem;
        }

        .message-content h5,
        .message-content h6 {
            font-size: 1rem;
        }

        .message-content p {
            margin: 12px 0;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .message-content pre {
            background: var(--bg-quaternary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            position: relative;
        }

        .message-content pre::before {
            content: 'Code';
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-content code {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .message-content pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--text-primary);
        }

        .message-content :not(pre) > code {
            background: var(--bg-quaternary);
            color: var(--accent-color);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-weight: 500;
        }

        .message-content blockquote {
            border-left: 4px solid var(--primary-color);
            background: var(--bg-quaternary);
            padding: 16px 20px;
            margin: 16px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: var(--text-secondary);
            position: relative;
        }

        .message-content blockquote::before {
            content: '"';
            font-size: 3rem;
            color: var(--primary-color);
            position: absolute;
            top: -10px;
            left: 10px;
            opacity: 0.3;
        }

        .message-content ul,
        .message-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 8px 0;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .message-content ul li {
            list-style: none;
            position: relative;
        }

        .message-content ul li::before {
            content: '•';
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            left: -16px;
        }

        .message-content ol li {
            list-style: none;
            counter-increment: list-counter;
            position: relative;
        }

        .message-content ol {
            counter-reset: list-counter;
        }

        .message-content ol li::before {
            content: counter(list-counter) '.';
            color: var(--primary-color);
            font-weight: 600;
            position: absolute;
            left: -24px;
            min-width: 20px;
        }

        .message-content hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 24px 0;
            opacity: 0.6;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .message-content th,
        .message-content td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content td {
            color: var(--text-primary);
        }

        .message-content tr:last-child td {
            border-bottom: none;
        }

        .message-content a {
            color: var(--primary-color);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: var(--transition);
        }

        .message-content a:hover {
            border-bottom-color: var(--primary-color);
        }

        .message-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content em {
            font-style: italic;
            color: var(--text-secondary);
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid var(--border-color);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        .mb-0 { margin-bottom: 0; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-graduation-cap"></i> StudyBuddy</h1>
                <p>Your AI-powered learning companion</p>
            </div>

            <div class="sidebar-content">

                <!-- Study Tools -->
                <div class="section-card hidden" id="studyToolsCard">
                    <h3 class="section-title">
                        <i class="fas fa-graduation-cap"></i> Study Tools
                    </h3>

                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-primary" onclick="app.generateAndShowRoadmap()" style="justify-content: flex-start;">
                            <i class="fas fa-map-marked-alt"></i> Learning Roadmap
                        </button>
                        <button class="btn btn-primary" onclick="app.generateAndShowFlashcards()" style="justify-content: flex-start;">
                            <i class="fas fa-layer-group"></i> Flashcards
                        </button>
                        <button class="btn btn-primary" onclick="app.generateAndShowQuiz()" style="justify-content: flex-start;">
                            <i class="fas fa-question-circle"></i> Knowledge Quiz
                        </button>
                        <button class="btn btn-primary" onclick="app.generateAndShowNotes()" style="justify-content: flex-start;">
                            <i class="fas fa-sticky-note"></i> Generate Notes
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section-card hidden" id="actionsCard">
                    <h3 class="section-title">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h3>

                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-outline" id="doubtsBtn">
                            <i class="fas fa-question-circle"></i> Review Doubts
                        </button>
                        <button class="btn btn-outline" id="clearBtn">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                    </div>
                </div>

                <!-- Recent Topics -->
                <div class="section-card hidden" id="topicsCard">
                    <h3 class="section-title">
                        <i class="fas fa-clock"></i> Recent Topics
                    </h3>
                    <div id="topicsList" class="text-muted">No topics yet</div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-header">
                <h2 class="main-title">Chat with your documents</h2>

                <!-- Round Action Buttons -->
                <div class="action-buttons">
                    <button class="round-btn new-chat-btn" id="newChatBtn" title="New Chat">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="round-btn profile-btn" onclick="app.showProfilePage()" title="Profile">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h3>Welcome to StudyBuddy!</h3>
                        <p>Upload PDF documents and start your interactive learning journey.</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Floating Chat Input -->
        <div class="chat-input-container">
            <form class="chat-input-form" id="chatForm">
                <button type="button" class="upload-btn" onclick="app.showUploadModal()" title="Upload Documents">
                    <i class="fas fa-upload"></i>
                </button>
                <select class="mode-selector" id="modeSelector" title="Response Mode">
                    <option value="standard">Standard</option>
                    <option value="speed">Fast Mode</option>
                    <option value="deep_dive">Deep Mode</option>
                </select>
                <textarea
                    class="chat-input"
                    id="chatInput"
                    placeholder="Ask a question about your documents..."
                    rows="1"
                    disabled
                ></textarea>
                <button type="submit" class="send-btn" id="sendBtn" disabled title="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h3 class="upload-modal-title">Upload Documents</h3>
                <button class="modal-close" onclick="app.closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="file-drop-zone" id="dropZone">
                <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                <p>Drop PDF files here</p>
                <small>or click to browse (max 2 files)</small>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf">
            </div>

            <div class="uploaded-files" id="uploadedFiles"></div>

            <button class="btn btn-primary btn-full process-btn" id="processBtn" disabled>
                <i class="fas fa-cog"></i>
                <span id="processBtnText">Process Documents</span>
                <div class="spinner hidden" id="processSpinner"></div>
            </button>
        </div>
    </div>

    <!-- GitHub-Style Profile Page -->
    <div class="profile-page" id="profilePage">
        <button class="profile-close" onclick="app.closeProfilePage()">
            <i class="fas fa-times"></i>
        </button>

        <div class="profile-container">
            <!-- Sidebar -->
            <div class="profile-sidebar">
                <div class="profile-card">
                    <div class="profile-avatar">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="profile-name">Study Enthusiast</div>
                    <div class="profile-username">@learner</div>
                    <div class="profile-bio">
                        Passionate learner exploring knowledge through AI-powered study tools.
                        Building streaks and mastering concepts one question at a time.
                    </div>
                    <div class="profile-stats-mini">
                        <span><i class="fas fa-fire"></i> <span class="number" id="sidebarCurrentStreak">0</span> day streak</span>
                        <span><i class="fas fa-star"></i> <span class="number" id="sidebarTotalQuestions">0</span> questions</span>
                    </div>
                </div>

                <!-- Achievements in Sidebar -->
                <div class="profile-card">
                    <div class="section-title">
                        <i class="fas fa-trophy"></i> Achievements
                        <button onclick="app.showAllAchievements()" style="margin-left: auto; background: none; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: var(--transition);" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.color='var(--primary-color)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-secondary)'">
                            View All
                        </button>
                    </div>
                    <div class="achievement-grid" id="achievementGridSidebar">
                        <!-- Recent achievements will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="profile-main">
                <!-- Contribution Heatmap -->
                <div class="contribution-section">
                    <div class="contribution-header">
                        <div class="contribution-title">
                            <span id="contributionCount">0</span> questions in the last year
                        </div>
                    </div>
                    <div class="heatmap-container">
                        <div class="heatmap-grid" id="heatmapGrid">
                            <!-- Heatmap squares will be generated by JavaScript -->
                        </div>
                        <div class="heatmap-legend">
                            <span>Less</span>
                            <div class="heatmap-legend-scale">
                                <div class="heatmap-legend-item level-0"></div>
                                <div class="heatmap-legend-item level-1"></div>
                                <div class="heatmap-legend-item level-2"></div>
                                <div class="heatmap-legend-item level-3"></div>
                                <div class="heatmap-legend-item level-4"></div>
                            </div>
                            <span>More</span>
                        </div>
                    </div>
                </div>

                <!-- Streak Cards -->
                <div class="streak-section">
                    <div class="streak-card current-streak">
                        <div class="streak-icon">🔥</div>
                        <div class="streak-number" id="currentStreakNumber">0</div>
                        <div class="streak-label">Current Streak</div>
                    </div>
                    <div class="streak-card max-streak">
                        <div class="streak-icon">⭐</div>
                        <div class="streak-number" id="maxStreakNumber">0</div>
                        <div class="streak-label">Longest Streak</div>
                    </div>
                </div>

                <!-- Activity Stats -->
                <div class="activity-stats">
                    <div class="activity-stat">
                        <div class="activity-stat-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="activity-stat-content">
                            <div class="activity-stat-number" id="totalQuestionsMain">0</div>
                            <div class="activity-stat-label">Total Questions</div>
                        </div>
                    </div>
                    <div class="activity-stat">
                        <div class="activity-stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="activity-stat-content">
                            <div class="activity-stat-number" id="totalStudyTime">0h</div>
                            <div class="activity-stat-label">Study Time</div>
                        </div>
                    </div>
                    <div class="activity-stat">
                        <div class="activity-stat-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="activity-stat-content">
                            <div class="activity-stat-number" id="documentsProcessed">0</div>
                            <div class="activity-stat-label">Documents</div>
                        </div>
                    </div>
                    <div class="activity-stat">
                        <div class="activity-stat-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="activity-stat-content">
                            <div class="activity-stat-number" id="averageConfidence">0%</div>
                            <div class="activity-stat-label">Avg Confidence</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="achievements-section">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i> Learning Progress
                    </div>
                    <div class="profile-card">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);" id="weeklyQuestions">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">This Week</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-color);" id="monthlyQuestions">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">This Month</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);" id="bestDay">Mon</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Most Active Day</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning-color);" id="studyStreak">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Days Active</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Modal Title</h3>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-trophy"></i> All Achievements</h3>
                <button class="modal-close" onclick="app.closeAchievementsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; text-align: center; color: var(--text-secondary);">
                    Track your learning journey and unlock achievements as you progress!
                </div>
                <div class="achievement-grid" id="allAchievementsGrid" style="grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px;">
                    <!-- All achievements will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Roadmap Page -->
    <div class="study-page" id="roadmapPage">
        <div class="study-header">
            <div class="study-title">
                <i class="fas fa-map-marked-alt"></i>
                Learning Roadmap
            </div>
            <button class="btn btn-outline" onclick="app.closeStudyPage()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div class="study-content">
            <div class="roadmap-container" id="roadmapContainer">
                <!-- Roadmap steps will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Flashcards Page -->
    <div class="study-page" id="flashcardsPage">
        <div class="study-header">
            <div class="study-title">
                <i class="fas fa-layer-group"></i>
                Flashcards
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span class="text-muted" id="flashcardProgress">0 / 0</span>
                <button class="btn btn-outline" onclick="app.shuffleFlashcards()">
                    <i class="fas fa-random"></i> Shuffle
                </button>
                <button class="btn btn-outline" onclick="app.closeStudyPage()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="study-content">
            <div class="text-center mb-4">
                <p class="text-muted">Click on any card to flip it and reveal the answer</p>
            </div>
            <div class="flashcard-container" id="flashcardContainer">
                <!-- Flashcards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Quiz Page -->
    <div class="study-page" id="quizPage">
        <div class="study-header">
            <div class="study-title">
                <i class="fas fa-question-circle"></i>
                Interactive Quiz
            </div>
            <button class="btn btn-outline" onclick="app.closeStudyPage()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div class="study-content">
            <div class="quiz-container">
                <div class="quiz-progress" id="quizProgressContainer">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span class="text-muted">Progress</span>
                        <span class="text-muted" id="quizProgressText">0 / 0</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="quizProgressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="quizContent">
                    <!-- Quiz questions will be inserted here -->
                </div>

                <div class="quiz-results hidden" id="quizResults">
                    <div class="results-score" id="resultsScore">0%</div>
                    <div class="results-message" id="resultsMessage">Great job!</div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn btn-primary" onclick="app.restartQuiz()">
                            <i class="fas fa-redo"></i> Retake Quiz
                        </button>
                        <button class="btn btn-outline" onclick="app.closeStudyPage()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Page -->
    <div class="study-page" id="notesPage">
        <div class="study-header">
            <div class="study-title">
                <i class="fas fa-sticky-note"></i>
                AI Generated Notes
            </div>
            <button class="btn btn-outline" onclick="app.closeStudyPage()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div class="study-content">
            <div class="notes-container" id="notesContainer">
                <!-- Notes will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        class StudyBuddyApp {
            constructor() {
                this.baseUrl = 'http://localhost:8000';
                this.selectedFiles = [];
                this.chatHistory = [];
                this.documentsUploaded = false;
                this.currentSession = null;
                this.currentStudyGuide = null;
                this.currentQuiz = null;
                this.quizState = {
                    currentQuestion: 0,
                    answers: [],
                    score: 0
                };
                this.userStats = {
                    totalQuestions: 0,
                    documentsProcessed: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    totalStudyTime: 0,
                    achievements: [],
                    lastStudyDate: null
                };

                this.initializeEventListeners();
                this.checkBackendHealth();
                this.loadSessionStats();
                this.loadUserStats();
            }

            initializeEventListeners() {
                // File upload
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const processBtn = document.getElementById('processBtn');
                const chatForm = document.getElementById('chatForm');
                const chatInput = document.getElementById('chatInput');

                console.log('Initializing event listeners...');
                console.log('chatForm found:', !!chatForm);
                console.log('chatInput found:', !!chatInput);

                // Drag and drop
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', this.handleDragOver.bind(this));
                dropZone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                dropZone.addEventListener('drop', this.handleDrop.bind(this));

                // File selection
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                // Process documents
                processBtn.addEventListener('click', this.processDocuments.bind(this));

                // Chat form
                if (chatForm) {
                    chatForm.addEventListener('submit', this.handleChatSubmit.bind(this));
                    console.log('Form submit listener attached');
                } else {
                    console.error('chatForm element not found!');
                }

                // Also add listener to send button as backup
                const sendBtn = document.getElementById('sendBtn');
                if (sendBtn) {
                    sendBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Send button clicked');
                        this.askQuestion();
                    });
                }

                chatInput.addEventListener('input', this.autoResizeTextarea.bind(this));

                // Action buttons
                document.getElementById('doubtsBtn').addEventListener('click', this.showDoubtsModal.bind(this));
                document.getElementById('clearBtn').addEventListener('click', this.clearAllData.bind(this));
                document.getElementById('newChatBtn').addEventListener('click', this.startNewChat.bind(this));

                // Modal
                document.getElementById('modalClose').addEventListener('click', this.closeModal.bind(this));
                document.getElementById('modal').addEventListener('click', (e) => {
                    if (e.target.id === 'modal') this.closeModal();
                });
            }

            handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropZone').classList.add('drag-over');
            }

            handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropZone').classList.remove('drag-over');
            }

            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('dropZone').classList.remove('drag-over');

                const files = Array.from(e.dataTransfer.files).filter(file =>
                    file.type === 'application/pdf'
                );

                if (files.length === 0) {
                    this.showAlert('Please drop PDF files only', 'warning');
                    return;
                }

                this.addFiles(files);
            }

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.addFiles(files);
            }

            addFiles(files) {
                // Filter PDF files
                const pdfFiles = files.filter(file => file.type === 'application/pdf');

                if (pdfFiles.length === 0) {
                    this.showAlert('Please select PDF files only', 'warning');
                    return;
                }

                // Check total file limit
                if (this.selectedFiles.length + pdfFiles.length > 2) {
                    this.showAlert('Maximum 2 PDF files allowed', 'warning');
                    return;
                }

                // Add new files (avoid duplicates)
                pdfFiles.forEach(file => {
                    if (!this.selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        this.selectedFiles.push(file);
                    }
                });

                this.renderUploadedFiles();
                this.updateProcessButton();
            }

            updateProcessButton() {
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = this.selectedFiles.length === 0;
            }

            renderUploadedFiles() {
                const container = document.getElementById('uploadedFiles');

                if (this.selectedFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = this.selectedFiles.map((file, index) => `
                    <div class="file-item">
                        <div class="file-info">
                            <i class="file-icon fas fa-file-pdf"></i>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${this.formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button class="remove-file" onclick="app.removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }

            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                this.renderUploadedFiles();
                this.updateProcessButton();
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async processDocuments() {
                if (this.selectedFiles.length === 0) return;

                const processBtn = document.getElementById('processBtn');
                const processBtnText = document.getElementById('processBtnText');
                const processSpinner = document.getElementById('processSpinner');

                // Show loading state
                processBtn.disabled = true;
                processBtnText.textContent = 'Processing...';
                processSpinner.classList.remove('hidden');

                try {
                    const formData = new FormData();
                    this.selectedFiles.forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch(`${this.baseUrl}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Upload failed');
                    }

                    const result = await response.json();

                    this.showAlert(`Successfully processed ${result.files_processed.length} files!`, 'success');

                    this.documentsUploaded = true;
                    this.enableChatInterface();
                    this.loadStats();
                    this.loadSessionStats();
                    this.clearChatHistory();

                    // Update user stats
                    this.updateUserStats({
                        documentsProcessed: this.userStats.documentsProcessed + result.files_processed.length
                    });

                    // Clear uploaded files
                    this.selectedFiles = [];
                    this.renderUploadedFiles();

                } catch (error) {
                    console.error('Upload error:', error);
                    this.showAlert(`Error: ${error.message}`, 'error');
                } finally {
                    // Reset button state
                    processBtn.disabled = false;
                    processBtnText.textContent = 'Process Documents';
                    processSpinner.classList.add('hidden');
                }
            }

            enableChatInterface() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');

                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.placeholder = 'Ask a question about your documents...';

                // Show additional UI elements
                document.getElementById('studyToolsCard').classList.remove('hidden');
                document.getElementById('actionsCard').classList.remove('hidden');
                document.getElementById('topicsCard').classList.remove('hidden');



                // Close upload modal if open
                this.closeUploadModal();
            }

            autoResizeTextarea() {
                const textarea = document.getElementById('chatInput');
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            handleChatSubmit(e) {
                console.log('handleChatSubmit called');
                e.preventDefault();
                this.askQuestion();
            }

            async askQuestion() {
                const chatInput = document.getElementById('chatInput');
                const modeSelector = document.getElementById('modeSelector');
                const question = chatInput.value.trim();
                const mode = modeSelector.value;

                if (!question || !this.documentsUploaded) {
                    this.showAlert('Please enter a question', 'warning');
                    return;
                }

                const sendBtn = document.getElementById('sendBtn');

                // Disable input
                chatInput.disabled = true;
                sendBtn.disabled = true;
                modeSelector.disabled = true;

                // Add user message with mode indicator
                const modeLabel = mode === 'speed' ? 'Fast Mode' : mode === 'deep_dive' ? 'Deep Mode' : 'Standard';
                this.addMessage('user', `${question} <span style="font-size: 0.8rem; opacity: 0.7; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 12px; margin-left: 8px;">${modeLabel}</span>`);

                // Clear input and reset height
                chatInput.value = '';
                chatInput.style.height = 'auto';

                // Add loading message
                const loadingId = this.addLoadingMessage();

                try {
                    const response = await fetch(`${this.baseUrl}/ask`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: question,
                            top_k: 5,
                            mode: mode
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Question processing failed');
                    }

                    const result = await response.json();

                    // Remove loading message
                    this.removeMessage(loadingId);

                    // Add assistant response
                    this.addMessage('assistant', result.answer, {
                        confidence: result.confidence,
                        sources: result.sources,
                        responseId: result.response_id,
                        mode: result.mode,
                        ttsEndpoint: result.tts_endpoint
                    });

                    // Update session stats and user stats
                    this.loadSessionStats();
                    this.updateStreak();
                    this.updateUserStats({
                        totalQuestions: this.userStats.totalQuestions + 1,
                        totalStudyTime: this.userStats.totalStudyTime + 1
                    });

                } catch (error) {
                    console.error('Question error:', error);
                    this.removeMessage(loadingId);
                    this.addMessage('assistant', `Sorry, there was an error processing your question: ${error.message}`);
                } finally {
                    // Re-enable input
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    modeSelector.disabled = false;
                    chatInput.focus();
                }
            }

            addMessage(role, content, metadata = {}) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                messageDiv.id = `msg-${Date.now()}`;

                const avatar = role === 'user' ?
                    '<i class="fas fa-user"></i>' :
                    '<i class="fas fa-robot"></i>';

                let messageContent = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        ${this.formatMessageContent(content)}
                `;

                // Add metadata for assistant messages
                if (role === 'assistant' && (metadata.sources || metadata.responseId || metadata.ttsEndpoint)) {
                    messageContent += `
                        <div class="message-meta">
                            ${metadata.sources ? `<span><i class="fas fa-book"></i> ${metadata.sources.length} sources</span>` : ''}
                            ${metadata.mode ? `<span style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">${metadata.mode === 'speed' ? 'Fast' : metadata.mode === 'deep_dive' ? 'Deep' : 'Standard'}</span>` : ''}
                            ${metadata.responseId ? `<button class="btn btn-outline" onclick="app.markAsDoubt('${metadata.responseId}')" style="font-size: 0.7rem; padding: 2px 8px;"><i class="fas fa-question"></i> Mark as unclear</button>` : ''}
                            ${metadata.ttsEndpoint ? `<button class="btn btn-outline" onclick="app.playTTS('${metadata.ttsEndpoint}')" style="font-size: 0.7rem; padding: 2px 8px;"><i class="fas fa-volume-up"></i> Listen</button>` : ''}
                        </div>
                    `;

                    // Add sources if available
                    if (metadata.sources && metadata.sources.length > 0) {
                        messageContent += `
                            <details style="margin-top: 12px;">
                                <summary style="cursor: pointer; font-weight: 500; color: var(--text-secondary);">
                                    <i class="fas fa-book"></i> View Sources
                                </summary>
                                <div style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                    ${metadata.sources.map(source => `
                                        <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                                            <div style="font-weight: 500; font-size: 0.8rem; color: var(--text-secondary);">
                                                ${source.filename} - Page ${source.page} (${(source.relevance_score * 100).toFixed(0)}% relevant)
                                            </div>
                                            <div style="font-size: 0.8rem; margin-top: 4px;">${source.preview}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        `;
                    }
                }

                messageContent += '</div>';
                messageDiv.innerHTML = messageContent;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                return messageDiv.id;
            }

            addLoadingMessage() {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messageDiv.id = `loading-${Date.now()}`;

                messageDiv.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Thinking...</span>
                        </div>
                    </div>
                `;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                return messageDiv.id;
            }

            removeMessage(messageId) {
                const message = document.getElementById(messageId);
                if (message) {
                    message.remove();
                }
            }

            formatMessageContent(content) {
                try {
                    // Configure marked.js for better rendering
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: false,
                        mangle: false
                    });

                    // Convert markdown to HTML
                    const rawHtml = marked.parse(content);

                    // Sanitize the HTML to prevent XSS attacks
                    const cleanHtml = DOMPurify.sanitize(rawHtml, {
                        ALLOWED_TAGS: [
                            'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                            'p', 'br', 'strong', 'em', 'u', 's',
                            'ul', 'ol', 'li',
                            'blockquote', 'pre', 'code',
                            'table', 'thead', 'tbody', 'tr', 'th', 'td',
                            'a', 'img',
                            'hr', 'div', 'span'
                        ],
                        ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'id']
                    });

                    return cleanHtml;
                } catch (error) {
                    console.error('Markdown parsing error:', error);
                    // Fallback to simple text formatting if markdown parsing fails
                    return this.formatMessageContentFallback(content);
                }
            }

            formatMessageContentFallback(content) {
                // Fallback formatting for when markdown parsing fails
                return content
                    // Headers
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')

                    // Code blocks
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')

                    // Inline code
                    .replace(/`([^`]+)`/g, '<code>$1</code>')

                    // Bold and italic
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')

                    // Lists
                    .replace(/^(\d+)\. (.*)$/gm, '<ol><li>$2</li></ol>')
                    .replace(/^[-*] (.*)$/gm, '<ul><li>$1</li></ul>')

                    // Blockquotes
                    .replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>')

                    // Line breaks
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')

                    // Wrap in paragraphs
                    .replace(/^(?!<)(.+)/, '<p>$1')
                    .replace(/(.+)(?!>)$/, '$1</p>');
            }

            startNewChat() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                this.chatHistory = [];
            }

            clearChatHistory() {
                this.startNewChat();
            }

            async markAsDoubt(responseId) {
                try {
                    const response = await fetch(`${this.baseUrl}/review/${responseId}/mark_unclear`, {
                        method: 'PATCH'
                    });

                    if (response.ok) {
                        this.showAlert('Question marked as unclear for review', 'info');
                    }
                } catch (error) {
                    console.error('Error marking doubt:', error);
                }
            }

            async playTTS(ttsEndpoint) {
                try {
                    // Create audio element and play
                    const audio = new Audio(`${this.baseUrl}${ttsEndpoint}`);
                    audio.play();
                    this.showAlert('Playing audio...', 'info');
                } catch (error) {
                    console.error('Error playing TTS:', error);
                    this.showAlert('Error playing audio', 'error');
                }
            }

            async loadStats() {
                try {
                    const response = await fetch(`${this.baseUrl}/stats`);
                    if (!response.ok) return;

                    const stats = await response.json();
                    this.renderStats(stats);
                } catch (error) {
                    console.error('Stats error:', error);
                }
            }

            renderStats(stats) {
                const statsGrid = document.getElementById('statsGrid');

                if (stats.total_chunks === 0) {
                    return;
                }

                statsGrid.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${stats.total_chunks}</div>
                        <div class="stat-label">Chunks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.total_documents}</div>
                        <div class="stat-label">Documents</div>
                    </div>
                `;
            }

            async loadSessionStats() {
                try {
                    const topicsResponse = await fetch(`${this.baseUrl}/session/ongoing_topics`);

                    if (topicsResponse.ok) {
                        const topics = await topicsResponse.json();
                        this.renderTopics(topics);
                    }
                } catch (error) {
                    console.error('Session stats error:', error);
                }
            }

            renderTopics(topics) {
                const topicsList = document.getElementById('topicsList');

                if (topics.length === 0) {
                    topicsList.innerHTML = '<div class="text-muted">No recent topics</div>';
                    return;
                }

                topicsList.innerHTML = topics.map(topic =>
                    `<div style="padding: 4px 0; font-size: 0.875rem;">${topic}</div>`
                ).join('');
            }

            // Modal functionality
            showModal(title, content) {
                const modal = document.getElementById('modal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');

                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modal.style.display = 'flex';
            }

            closeModal() {
                const modal = document.getElementById('modal');
                modal.style.display = 'none';
            }

            async showStudyGuideOptions() {
                if (!this.documentsUploaded) {
                    this.showAlert('Please upload documents first', 'warning');
                    return;
                }

                this.showModal('Study Tools', `
                    <div style="display: grid; gap: 16px;">
                        <button class="btn btn-primary btn-full" onclick="app.generateAndShowRoadmap()" style="padding: 20px; font-size: 1rem;">
                            <i class="fas fa-map-marked-alt" style="margin-right: 12px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-weight: 600;">Learning Roadmap</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">Step-by-step learning path</div>
                            </div>
                        </button>

                        <button class="btn btn-primary btn-full" onclick="app.generateAndShowFlashcards()" style="padding: 20px; font-size: 1rem;">
                            <i class="fas fa-layer-group" style="margin-right: 12px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-weight: 600;">Interactive Flashcards</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">Key concepts and definitions</div>
                            </div>
                        </button>

                        <button class="btn btn-primary btn-full" onclick="app.generateAndShowQuiz()" style="padding: 20px; font-size: 1rem;">
                            <i class="fas fa-question-circle" style="margin-right: 12px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-weight: 600;">Knowledge Quiz</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">Test your understanding</div>
                            </div>
                        </button>

                        <button class="btn btn-primary btn-full" onclick="app.generateAndShowNotes()" style="padding: 20px; font-size: 1rem;">
                            <i class="fas fa-sticky-note" style="margin-right: 12px; font-size: 1.2rem;"></i>
                            <div>
                                <div style="font-weight: 600;">AI Generated Notes</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">Structured study notes</div>
                            </div>
                        </button>
                    </div>
                `);
            }

            async generateStudyGuide() {
                if (this.currentStudyGuide) {
                    return this.currentStudyGuide;
                }

                try {
                    // Get the first uploaded document filename
                    const statsResponse = await fetch(`${this.baseUrl}/stats`);
                    const stats = await statsResponse.json();

                    if (stats.documents && stats.documents.length > 0) {
                        const filename = stats.documents[0].filename;

                        const response = await fetch(`${this.baseUrl}/generate_study_guide/${filename}`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to generate study guide');
                        }

                        this.currentStudyGuide = await response.json();
                        return this.currentStudyGuide;
                    }
                } catch (error) {
                    console.error('Study guide error:', error);
                    throw error;
                }
            }

            async generateAndShowRoadmap() {
                this.closeModal();

                try {
                    const studyGuide = await this.generateStudyGuide();
                    this.showRoadmapPage(studyGuide.roadmap);
                } catch (error) {
                    this.showAlert(`Error generating roadmap: ${error.message}`, 'error');
                }
            }

            async generateAndShowFlashcards() {
                this.closeModal();

                try {
                    const studyGuide = await this.generateStudyGuide();
                    this.showFlashcardsPage(studyGuide.flashcards);
                } catch (error) {
                    this.showAlert(`Error generating flashcards: ${error.message}`, 'error');
                }
            }

            async generateAndShowQuiz() {
                this.closeModal();

                try {
                    const studyGuide = await this.generateStudyGuide();
                    this.showQuizPage(studyGuide.quiz);
                } catch (error) {
                    this.showAlert(`Error generating quiz: ${error.message}`, 'error');
                }
            }

            async generateAndShowNotes() {
                if (!this.documentsUploaded) {
                    this.showAlert('Please upload documents first', 'warning');
                    return;
                }

                try {
                    // Get the first uploaded document filename
                    const statsResponse = await fetch(`${this.baseUrl}/stats`);
                    const stats = await statsResponse.json();

                    if (stats.documents && stats.documents.length > 0) {
                        const filename = stats.documents[0].filename;

                        this.showAlert('Generating AI notes...', 'info');

                        const response = await fetch(`${this.baseUrl}/generate_notes/${filename}`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to generate notes');
                        }

                        const notes = await response.json();
                        this.showNotesPage(notes);
                    } else {
                        this.showAlert('No documents found to generate notes from', 'warning');
                    }
                } catch (error) {
                    console.error('Notes generation error:', error);
                    this.showAlert(`Error generating notes: ${error.message}`, 'error');
                }
            }

            showRoadmapPage(roadmap) {
                const roadmapContainer = document.getElementById('roadmapContainer');

                // Define icons for each step
                const stepIcons = [
                    'fas fa-play-circle',      // Start/Introduction
                    'fas fa-book-open',        // Learning/Reading
                    'fas fa-lightbulb',        // Understanding/Concepts
                    'fas fa-cogs',             // Practice/Application
                    'fas fa-trophy',           // Mastery/Completion
                    'fas fa-rocket',           // Advanced/Next Steps
                    'fas fa-star'              // Excellence/Expertise
                ];

                const stepBadges = [
                    'Start Here',
                    'Foundation',
                    'Core Concepts',
                    'Practice',
                    'Advanced',
                    'Mastery',
                    'Expert'
                ];

                roadmapContainer.innerHTML = `
                    <div class="roadmap-header">
                        <div class="roadmap-title">🗺️ Your Learning Journey</div>
                        <div class="roadmap-subtitle">Follow this structured path to master the material</div>
                    </div>

                    <div class="roadmap-progress">
                        <div class="progress-indicator">
                            <i class="fas fa-route"></i>
                            <span>${roadmap.length} Learning Steps</span>
                        </div>
                        <div class="progress-indicator">
                            <i class="fas fa-clock"></i>
                            <span>Estimated: ${roadmap.length * 15-20} minutes</span>
                        </div>
                        <div class="progress-indicator">
                            <i class="fas fa-graduation-cap"></i>
                            <span>Structured Learning</span>
                        </div>
                    </div>

                    ${roadmap.map((step, index) => `
                        <div class="roadmap-step">
                            <div class="step-indicator">
                                <div class="step-number">${index + 1}</div>
                                <div class="step-icon">
                                    <i class="${stepIcons[index] || 'fas fa-circle'}"></i>
                                </div>
                            </div>
                            <div class="step-content">
                                <div class="step-header">
                                    <div class="step-title">${step.step_title}</div>
                                    <div class="step-badge">${stepBadges[index] || `Step ${index + 1}`}</div>
                                </div>
                                <div class="step-description">${this.formatMessageContent(step.description)}</div>
                                <div class="step-actions">
                                    <button class="step-action-btn" onclick="app.markStepComplete(${index})">
                                        <i class="fas fa-check"></i> Mark Complete
                                    </button>
                                    <button class="step-action-btn" onclick="app.askAboutStep('${step.step_title}')">
                                        <i class="fas fa-question"></i> Ask Question
                                    </button>
                                    ${index < roadmap.length - 1 ? `
                                        <button class="step-action-btn" onclick="app.scrollToStep(${index + 1})">
                                            <i class="fas fa-arrow-down"></i> Next Step
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}

                    <div style="text-align: center; margin-top: 48px; padding: 32px; background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border-color);">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">🎉 Congratulations!</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">You've completed the learning roadmap. Ready to test your knowledge?</p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="btn btn-primary" onclick="app.generateAndShowQuiz()">
                                <i class="fas fa-question-circle"></i> Take Quiz
                            </button>
                            <button class="btn btn-outline" onclick="app.generateAndShowFlashcards()">
                                <i class="fas fa-layer-group"></i> Review Flashcards
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('roadmapPage').classList.add('active');
            }

            showFlashcardsPage(flashcards) {
                const flashcardContainer = document.getElementById('flashcardContainer');
                const flashcardProgress = document.getElementById('flashcardProgress');

                flashcardProgress.textContent = `${flashcards.length} cards`;

                flashcardContainer.innerHTML = flashcards.map((card, index) => `
                    <div class="flashcard" onclick="app.flipFlashcard(${index})">
                        <div class="flashcard-inner" id="flashcard-${index}">
                            <div class="flashcard-front">
                                <div class="flashcard-label">Question</div>
                                <div class="flashcard-text">${this.formatMessageContent(card.question)}</div>
                            </div>
                            <div class="flashcard-back">
                                <div class="flashcard-label">Answer</div>
                                <div class="flashcard-text">${this.formatMessageContent(card.answer)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('flashcardsPage').classList.add('active');
            }

            flipFlashcard(index) {
                const flashcard = document.getElementById(`flashcard-${index}`).parentElement;
                flashcard.classList.toggle('flipped');
            }

            shuffleFlashcards() {
                const container = document.getElementById('flashcardContainer');
                const cards = Array.from(container.children);

                // Shuffle array
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }

                // Re-append in new order
                cards.forEach(card => container.appendChild(card));

                this.showAlert('Flashcards shuffled!', 'info');
            }

            showQuizPage(quiz) {
                this.currentQuiz = quiz;
                this.quizState = {
                    currentQuestion: 0,
                    answers: new Array(quiz.length).fill(null),
                    score: 0
                };

                this.renderQuizQuestion();
                document.getElementById('quizPage').classList.add('active');
            }

            showNotesPage(notes) {
                const notesContainer = document.getElementById('notesContainer');

                notesContainer.innerHTML = `
                    <div class="notes-header">
                        <div class="notes-topic">${notes.topic}</div>
                        <div class="notes-summary">${this.formatMessageContent(notes.summary)}</div>
                    </div>

                    ${notes.notes.map((note, index) => `
                        <div class="note-item">
                            <div class="note-title">${note.title}</div>
                            <div class="note-details">${this.formatMessageContent(note.details)}</div>
                            <div class="note-keywords">
                                ${note.keywords.map(keyword => `
                                    <span class="keyword-tag">${keyword}</span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                `;

                document.getElementById('notesPage').classList.add('active');
            }

            renderQuizQuestion() {
                const quiz = this.currentQuiz;
                const state = this.quizState;
                const question = quiz[state.currentQuestion];

                // Update progress
                document.getElementById('quizProgressText').textContent = `${state.currentQuestion + 1} / ${quiz.length}`;
                document.getElementById('quizProgressBar').style.width = `${((state.currentQuestion + 1) / quiz.length) * 100}%`;

                // Render question
                document.getElementById('quizContent').innerHTML = `
                    <div class="quiz-question">
                        <div class="question-number">Question ${state.currentQuestion + 1} of ${quiz.length}</div>
                        <div class="question-text">${question.question_text}</div>
                        <div class="quiz-options">
                            ${question.options.map((option, index) => `
                                <div class="quiz-option ${state.answers[state.currentQuestion] === index ? 'selected' : ''}"
                                     onclick="app.selectQuizOption(${index})">
                                    <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                                    <div>${option}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="quiz-navigation">
                        <button class="btn btn-outline" onclick="app.previousQuestion()"
                                ${state.currentQuestion === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>

                        <div style="display: flex; gap: 12px;">
                            ${state.currentQuestion === quiz.length - 1 ?
                                '<button class="btn btn-success" onclick="app.finishQuiz()"><i class="fas fa-check"></i> Finish Quiz</button>' :
                                '<button class="btn btn-primary" onclick="app.nextQuestion()">Next <i class="fas fa-chevron-right"></i></button>'
                            }
                        </div>
                    </div>
                `;
            }

            selectQuizOption(optionIndex) {
                this.quizState.answers[this.quizState.currentQuestion] = optionIndex;
                this.renderQuizQuestion();
            }

            previousQuestion() {
                if (this.quizState.currentQuestion > 0) {
                    this.quizState.currentQuestion--;
                    this.renderQuizQuestion();
                }
            }

            nextQuestion() {
                if (this.quizState.currentQuestion < this.currentQuiz.length - 1) {
                    this.quizState.currentQuestion++;
                    this.renderQuizQuestion();
                }
            }

            finishQuiz() {
                // Calculate score
                let correct = 0;
                this.currentQuiz.forEach((question, index) => {
                    const userAnswer = this.quizState.answers[index];
                    const correctAnswer = question.options.indexOf(question.correct_answer);
                    if (userAnswer === correctAnswer) {
                        correct++;
                    }
                });

                const score = Math.round((correct / this.currentQuiz.length) * 100);
                this.quizState.score = score;

                // Show results
                document.getElementById('quizContent').classList.add('hidden');
                document.getElementById('quizProgressContainer').classList.add('hidden');

                const resultsContainer = document.getElementById('quizResults');
                resultsContainer.classList.remove('hidden');

                document.getElementById('resultsScore').textContent = `${score}%`;

                let message = '';
                if (score >= 90) message = '🎉 Excellent! You\'ve mastered this material!';
                else if (score >= 80) message = '👏 Great job! You have a solid understanding!';
                else if (score >= 70) message = '👍 Good work! Consider reviewing a few concepts.';
                else if (score >= 60) message = '📚 Not bad! Some more study would be helpful.';
                else message = '💪 Keep studying! You\'ll get there with practice.';

                document.getElementById('resultsMessage').textContent = message;
            }

            restartQuiz() {
                document.getElementById('quizResults').classList.add('hidden');
                document.getElementById('quizContent').classList.remove('hidden');
                document.getElementById('quizProgressContainer').classList.remove('hidden');

                this.quizState = {
                    currentQuestion: 0,
                    answers: new Array(this.currentQuiz.length).fill(null),
                    score: 0
                };

                this.renderQuizQuestion();
            }

            closeStudyPage() {
                document.querySelectorAll('.study-page').forEach(page => {
                    page.classList.remove('active');
                });
            }

            // New roadmap interaction functions
            markStepComplete(stepIndex) {
                const stepElement = document.querySelectorAll('.roadmap-step')[stepIndex];
                if (stepElement) {
                    stepElement.style.opacity = '0.7';
                    stepElement.querySelector('.step-badge').textContent = '✅ Complete';
                    stepElement.querySelector('.step-badge').style.background = 'rgba(34, 197, 94, 0.1)';
                    stepElement.querySelector('.step-badge').style.color = 'var(--success-color)';

                    this.showAlert(`Step ${stepIndex + 1} marked as complete!`, 'success');

                    // Update user stats
                    this.updateUserStats({
                        totalStudyTime: this.userStats.totalStudyTime + 5
                    });
                }
            }

            askAboutStep(stepTitle) {
                this.closeStudyPage();
                const chatInput = document.getElementById('chatInput');
                chatInput.value = `Can you explain more about: ${stepTitle}`;
                chatInput.focus();
                this.autoResizeTextarea();
            }

            scrollToStep(stepIndex) {
                const stepElement = document.querySelectorAll('.roadmap-step')[stepIndex];
                if (stepElement) {
                    stepElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });

                    // Add a highlight effect
                    stepElement.style.transform = 'scale(1.02)';
                    stepElement.style.boxShadow = '0 0 20px rgba(16, 163, 127, 0.5)';

                    setTimeout(() => {
                        stepElement.style.transform = '';
                        stepElement.style.boxShadow = '';
                    }, 2000);
                }
            }

            // Upload Modal Methods
            showUploadModal() {
                document.getElementById('uploadModal').classList.add('active');
            }

            closeUploadModal() {
                document.getElementById('uploadModal').classList.remove('active');
            }

            // Profile Page Methods
            showProfilePage() {
                // Ensure user stats are loaded
                this.loadUserStats();

                console.log('Showing profile page with stats:', this.userStats);

                this.renderProfileStats();
                this.renderAchievements();
                this.renderHeatmap();
                this.renderStreakData();
                this.renderActivityStats();
                document.getElementById('profilePage').classList.add('active');
            }

            closeProfilePage() {
                document.getElementById('profilePage').classList.remove('active');
            }

            loadUserStats() {
                // Load from localStorage or initialize
                const saved = localStorage.getItem('userStats');
                if (saved) {
                    this.userStats = { ...this.userStats, ...JSON.parse(saved) };
                }
            }

            saveUserStats() {
                localStorage.setItem('userStats', JSON.stringify(this.userStats));
            }

            updateUserStats(updates) {
                Object.assign(this.userStats, updates);
                this.saveUserStats();
            }

            updateStreak() {
                const today = new Date().toDateString();
                const lastStudy = this.userStats.lastStudyDate;

                if (lastStudy !== today) {
                    if (lastStudy) {
                        const lastDate = new Date(lastStudy);
                        const todayDate = new Date(today);
                        const diffTime = todayDate - lastDate;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays === 1) {
                            // Consecutive day - increment streak
                            this.userStats.currentStreak++;
                        } else if (diffDays > 1) {
                            // Streak broken - reset to 1
                            this.userStats.currentStreak = 1;
                        }
                        // If diffDays === 0, same day - don't change streak
                    } else {
                        // First time studying
                        this.userStats.currentStreak = 1;
                    }

                    // Update max streak if current is higher
                    if (this.userStats.currentStreak > this.userStats.maxStreak) {
                        this.userStats.maxStreak = this.userStats.currentStreak;
                    }

                    this.userStats.lastStudyDate = today;
                    this.saveUserStats();
                }
            }

            renderProfileStats() {
                // Legacy function - now handled by specialized functions
                // for the new GitHub-style layout
            }

            renderHeatmap() {
                const heatmapGrid = document.getElementById('heatmapGrid');
                const contributionCount = document.getElementById('contributionCount');

                // Generate heatmap for the last year (365 days)
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const oneYearAgo = new Date(today.getTime() - (365 * 24 * 60 * 60 * 1000));

                // Get user's total questions for today
                const todayQuestions = this.userStats.totalQuestions || 0;

                let heatmapHTML = '';

                for (let i = 0; i < 365; i++) {
                    const date = new Date(oneYearAgo.getTime() + (i * 24 * 60 * 60 * 1000));
                    const dateStr = date.toISOString().split('T')[0];

                    // Only today has activity, all other days are empty
                    const activity = (dateStr === todayStr) ? todayQuestions : 0;
                    const level = this.getActivityLevel(activity);

                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const monthName = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    heatmapHTML += `
                        <div class="heatmap-day level-${level}"
                             title="${activity} questions on ${dayName}, ${monthName}"
                             data-date="${dateStr}"
                             data-count="${activity}">
                        </div>
                    `;
                }

                heatmapGrid.innerHTML = heatmapHTML;
                contributionCount.textContent = todayQuestions;
            }

            getActivityLevel(count) {
                if (count === 0) return 0;
                if (count <= 2) return 1;
                if (count <= 4) return 2;
                if (count <= 6) return 3;
                return 4;
            }

            renderStreakData() {
                document.getElementById('currentStreakNumber').textContent = this.userStats.currentStreak;
                document.getElementById('maxStreakNumber').textContent = this.userStats.maxStreak;
                document.getElementById('sidebarCurrentStreak').textContent = this.userStats.currentStreak;
                document.getElementById('sidebarTotalQuestions').textContent = this.userStats.totalQuestions;
            }

            renderActivityStats() {
                const stats = this.userStats;

                document.getElementById('totalQuestionsMain').textContent = stats.totalQuestions;
                document.getElementById('totalStudyTime').textContent = `${Math.round(stats.totalStudyTime / 60)}h`;
                document.getElementById('documentsProcessed').textContent = stats.documentsProcessed || 0;
                document.getElementById('averageConfidence').textContent = '85%'; // Mock data

                // Weekly and monthly stats (mock data based on total)
                const weeklyQuestions = Math.floor(stats.totalQuestions * 0.1);
                const monthlyQuestions = Math.floor(stats.totalQuestions * 0.3);

                document.getElementById('weeklyQuestions').textContent = weeklyQuestions;
                document.getElementById('monthlyQuestions').textContent = monthlyQuestions;
                document.getElementById('bestDay').textContent = 'Wed'; // Mock data
                document.getElementById('studyStreak').textContent = Math.floor(stats.totalQuestions / 5);
            }

            renderAchievements() {
                const achievements = [
                    // Question Milestones
                    { id: 'first_question', icon: '🎯', name: 'First Question', requirement: 1, stat: 'totalQuestions', description: 'Ask your first question' },
                    { id: 'curious_learner', icon: '🤔', name: 'Curious Learner', requirement: 10, stat: 'totalQuestions', description: 'Ask 10 questions' },
                    { id: 'knowledge_seeker', icon: '🧠', name: 'Knowledge Seeker', requirement: 50, stat: 'totalQuestions', description: 'Ask 50 questions' },
                    { id: 'scholar', icon: '🎓', name: 'Scholar', requirement: 100, stat: 'totalQuestions', description: 'Ask 100 questions' },
                    { id: 'expert', icon: '🔬', name: 'Expert', requirement: 250, stat: 'totalQuestions', description: 'Ask 250 questions' },
                    { id: 'master', icon: '🧙‍♂️', name: 'Master', requirement: 500, stat: 'totalQuestions', description: 'Ask 500 questions' },

                    // Document Achievements
                    { id: 'first_document', icon: '📄', name: 'First Document', requirement: 1, stat: 'documentsProcessed', description: 'Upload your first document' },
                    { id: 'document_collector', icon: '📁', name: 'Document Collector', requirement: 3, stat: 'documentsProcessed', description: 'Upload 3 documents' },
                    { id: 'document_master', icon: '📚', name: 'Document Master', requirement: 5, stat: 'documentsProcessed', description: 'Upload 5 documents' },
                    { id: 'library_builder', icon: '🏛️', name: 'Library Builder', requirement: 10, stat: 'documentsProcessed', description: 'Upload 10 documents' },

                    // Streak Achievements
                    { id: 'streak_starter', icon: '🔥', name: 'Streak Starter', requirement: 3, stat: 'maxStreak', description: 'Maintain a 3-day streak' },
                    { id: 'streak_master', icon: '⚡', name: 'Streak Master', requirement: 7, stat: 'maxStreak', description: 'Maintain a 7-day streak' },
                    { id: 'streak_champion', icon: '🏆', name: 'Streak Champion', requirement: 14, stat: 'maxStreak', description: 'Maintain a 2-week streak' },
                    { id: 'streak_legend', icon: '👑', name: 'Streak Legend', requirement: 30, stat: 'maxStreak', description: 'Maintain a 30-day streak' },
                    { id: 'streak_immortal', icon: '💎', name: 'Streak Immortal', requirement: 100, stat: 'maxStreak', description: 'Maintain a 100-day streak' },

                    // Study Time Achievements
                    { id: 'study_time_bronze', icon: '🥉', name: 'Study Bronze', requirement: 60, stat: 'totalStudyTime', description: 'Study for 1 hour total' },
                    { id: 'study_time_silver', icon: '🥈', name: 'Study Silver', requirement: 300, stat: 'totalStudyTime', description: 'Study for 5 hours total' },
                    { id: 'study_time_gold', icon: '🥇', name: 'Study Gold', requirement: 600, stat: 'totalStudyTime', description: 'Study for 10 hours total' },
                    { id: 'study_time_platinum', icon: '💍', name: 'Study Platinum', requirement: 1200, stat: 'totalStudyTime', description: 'Study for 20 hours total' },

                    // Special Achievements
                    { id: 'early_bird', icon: '🌅', name: 'Early Bird', requirement: 5, stat: 'totalQuestions', description: 'One of the first users!' },
                    { id: 'night_owl', icon: '🦉', name: 'Night Owl', requirement: 25, stat: 'totalQuestions', description: 'Study late into the night' },
                    { id: 'weekend_warrior', icon: '⚔️', name: 'Weekend Warrior', requirement: 15, stat: 'totalQuestions', description: 'Keep learning on weekends' },
                    { id: 'speed_reader', icon: '💨', name: 'Speed Reader', requirement: 20, stat: 'totalQuestions', description: 'Quick to ask questions' },
                    { id: 'deep_thinker', icon: '🤯', name: 'Deep Thinker', requirement: 35, stat: 'totalQuestions', description: 'Ask thoughtful questions' }
                ];

                // Store achievements for use in modal
                this.allAchievements = achievements;

                // Render recent achievements in sidebar (show only 3 most recent earned)
                const earnedAchievements = achievements.filter(achievement =>
                    this.userStats[achievement.stat] >= achievement.requirement
                );
                const recentAchievements = earnedAchievements.slice(-3); // Get last 3 earned

                const achievementGridSidebar = document.getElementById('achievementGridSidebar');
                if (recentAchievements.length === 0) {
                    achievementGridSidebar.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; grid-column: 1 / -1;">
                            Start learning to unlock achievements!
                        </div>
                    `;
                } else {
                    achievementGridSidebar.innerHTML = recentAchievements.map(achievement => `
                        <div class="achievement-badge earned" title="${achievement.description}">
                            <div class="achievement-icon">${achievement.icon}</div>
                            <div class="achievement-name">${achievement.name}</div>
                        </div>
                    `).join('');
                }
            }

            showAllAchievements() {
                const allAchievementsGrid = document.getElementById('allAchievementsGrid');

                allAchievementsGrid.innerHTML = this.allAchievements.map(achievement => {
                    const isEarned = this.userStats[achievement.stat] >= achievement.requirement;
                    const progress = Math.min(100, (this.userStats[achievement.stat] / achievement.requirement) * 100);

                    return `
                        <div class="achievement-badge ${isEarned ? 'earned' : ''}" style="padding: 20px; position: relative;">
                            <div class="achievement-icon" style="font-size: 2rem; margin-bottom: 12px;">${achievement.icon}</div>
                            <div class="achievement-name" style="font-size: 0.8rem; margin-bottom: 8px;">${achievement.name}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.3;">
                                ${achievement.description}
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                ${this.userStats[achievement.stat]}/${achievement.requirement}
                            </div>
                            ${!isEarned ? `
                                <div style="width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                                    <div style="width: ${progress}%; height: 100%; background: var(--primary-color); border-radius: 2px; transition: width 0.3s ease;"></div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                document.getElementById('achievementsModal').classList.add('active');
            }

            closeAchievementsModal() {
                document.getElementById('achievementsModal').classList.remove('active');
            }

            renderLearningProgress() {
                const learningProgress = document.getElementById('learningProgress');

                const progressData = [
                    { label: 'Questions Asked', current: this.userStats.totalQuestions, target: 100 },
                    { label: 'Documents Processed', current: this.userStats.documentsProcessed, target: 10 },
                    { label: 'Current Streak', current: this.userStats.currentStreak, target: 30 },
                    { label: 'Best Streak', current: this.userStats.maxStreak, target: 50 }
                ];

                learningProgress.innerHTML = progressData.map(item => {
                    const percentage = Math.min((item.current / item.target) * 100, 100);
                    return `
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-primary); font-weight: 500;">${item.label}</span>
                                <span style="color: var(--text-secondary);">${item.current} / ${item.target}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async showDoubtsModal() {
                this.showModal('Review Unclear Responses', `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading unclear responses...</span>
                    </div>
                `);

                try {
                    const response = await fetch(`${this.baseUrl}/review/unclear`);
                    if (!response.ok) {
                        throw new Error('Failed to load unclear responses');
                    }

                    const doubts = await response.json();
                    this.renderDoubts(doubts);
                } catch (error) {
                    console.error('Doubts error:', error);
                    document.getElementById('modalBody').innerHTML = `
                        <div class="text-center">
                            <p>Error loading unclear responses: ${error.message}</p>
                        </div>
                    `;
                }
            }

            renderDoubts(doubts) {
                const modalBody = document.getElementById('modalBody');

                if (doubts.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success-color); margin-bottom: 16px;"></i>
                            <h4>No unclear responses!</h4>
                            <p>All your questions have clear answers. Keep learning!</p>
                        </div>
                    `;
                    return;
                }

                modalBody.innerHTML = `
                    <div style="max-height: 60vh; overflow-y: auto;">
                        ${doubts.map((doubt, index) => `
                            <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--warning-color);">
                                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                    Q: ${doubt.question}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 8px;">
                                    ${doubt.answer.substring(0, 200)}${doubt.answer.length > 200 ? '...' : ''}
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">
                                        ${new Date(doubt.timestamp).toLocaleDateString()}
                                    </span>
                                    <span style="background: var(--warning-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem;">Unclear</span>
                                    <button onclick="app.resolveDoubt('${doubt.id}')" style="background: var(--success-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Mark as Clear</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            async markDoubtUnclear(responseId) {
                try {
                    const response = await fetch(`${this.baseUrl}/review/${responseId}/mark_unclear`, {
                        method: 'PATCH'
                    });

                    if (response.ok) {
                        this.showAlert('Response marked as unclear', 'info');
                        this.showDoubtsModal(); // Refresh the modal
                    }
                } catch (error) {
                    console.error('Error marking response as unclear:', error);
                }
            }

            async resolveDoubt(responseId) {
                try {
                    const response = await fetch(`${this.baseUrl}/review/${responseId}/resolve`, {
                        method: 'PATCH'
                    });

                    if (response.ok) {
                        this.showAlert('Response resolved!', 'success');
                        this.showDoubtsModal(); // Refresh the modal
                    }
                } catch (error) {
                    console.error('Error resolving response:', error);
                }
            }

            async checkBackendHealth() {
                try {
                    const response = await fetch(`${this.baseUrl}/health`);
                    if (response.ok) {
                        // Check if documents are already loaded
                        const statsResponse = await fetch(`${this.baseUrl}/stats`);
                        if (statsResponse.ok) {
                            const stats = await statsResponse.json();
                            if (stats.total_chunks > 0) {
                                this.documentsUploaded = true;
                                this.enableChatInterface();
                                this.loadStats();
                                this.loadSessionStats();
                            }
                        }
                    }
                } catch (error) {
                    this.showAlert('Backend not available. Make sure the server is running on port 8000.', 'error');
                }
            }

            async clearAllData() {
                if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.baseUrl}/clear`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to clear data');
                    }

                    // Reset application state
                    this.documentsUploaded = false;
                    this.selectedFiles = [];
                    this.chatHistory = [];

                    // Reset UI
                    this.renderUploadedFiles();
                    this.updateProcessButton();
                    this.startNewChat();

                    // Hide additional UI elements
                    document.getElementById('studyToolsCard').classList.add('hidden');
                    document.getElementById('actionsCard').classList.add('hidden');
                    document.getElementById('topicsCard').classList.add('hidden');

                    // Disable chat
                    document.getElementById('chatInput').disabled = true;
                    document.getElementById('sendBtn').disabled = true;
                    document.getElementById('chatInput').placeholder = 'Upload documents to start chatting...';



                    // Show empty state
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = `
                        <div class="empty-state" id="emptyState">
                            <div class="empty-state-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <h3>Welcome to StudyBuddy!</h3>
                            <p>Upload PDF documents and start your interactive learning journey.</p>
                        </div>
                    `;

                    this.showAlert('All data cleared successfully!', 'success');

                } catch (error) {
                    console.error('Clear data error:', error);
                    this.showAlert(`Error clearing data: ${error.message}`, 'error');
                }
            }

            showAlert(message, type = 'info') {
                const alertContainer = document.getElementById('alertContainer');
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${type}`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${this.getAlertIcon(type)}"></i>
                    ${message}
                `;

                alertContainer.appendChild(alertDiv);

                // Auto-remove after 4 seconds
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 300);
                }, 4000);
            }

            getAlertIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
        }

        // Initialize the app
        const app = new StudyBuddyApp();
    </script>
</body>
</html>
